<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroPredict - Sistema de Predicci√≥n de Cultivos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
        }

        .user-info span {
            color: #4a5568;
            font-weight: 500;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #c53030;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .auth-toggle {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #667eea;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .auth-toggle button.active {
            background: #667eea;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #718096;
            width: auto;
            padding: 8px 16px;
        }

        .file-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .results-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-top: 30px;
        }

        .prediction-card {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .prediction-card h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .confidence {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .prediction-mini {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .recommendations {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .chart-container {
            margin-top: 20px;
            height: 300px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert-info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .datasets-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .dataset-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }

        .dataset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .dataset-name {
            font-weight: 600;
            color: #4a5568;
        }

        .dataset-meta {
            font-size: 14px;
            color: #718096;
        }

        .dataset-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            width: auto;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c53030;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .user-info {
                position: static;
                margin-top: 20px;
                text-align: center;
            }

            .predictions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Auth Screen -->
        <div v-if="!isAuthenticated" class="auth-container">
            <h1 style="text-align: center; color: #4a5568; margin-bottom: 30px;">üå± AgroPredict</h1>
            
            <div class="auth-toggle">
                <button :class="{ active: authMode === 'login' }" @click="authMode = 'login'">
                    Iniciar Sesi√≥n
                </button>
                <button :class="{ active: authMode === 'register' }" @click="authMode = 'register'">
                    Registrarse
                </button>
            </div>

            <!-- Login Form -->
            <form v-if="authMode === 'login'" @submit.prevent="login">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" v-model="loginForm.email" required>
                </div>
                <div class="input-group">
                    <label>Contrase√±a</label>
                    <input type="password" v-model="loginForm.password" required>
                </div>
                <button type="submit" class="btn" :disabled="loading">
                    <span v-if="loading">Iniciando sesi√≥n...</span>
                    <span v-else>Iniciar Sesi√≥n</span>
                </button>
            </form>

            <!-- Register Form -->
            <form v-if="authMode === 'register'" @submit.prevent="register">
                <div class="input-group">
                    <label>Nombre de usuario</label>
                    <input type="text" v-model="registerForm.username" required>
                </div>
                <div class="input-group">
                    <label>Nombre</label>
                    <input type="text" v-model="registerForm.first_name" required>
                </div>
                <div class="input-group">
                    <label>Apellido</label>
                    <input type="text" v-model="registerForm.last_name" required>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" v-model="registerForm.email" required>
                </div>
                <div class="input-group">
                    <label>Contrase√±a</label>
                    <input type="password" v-model="registerForm.password" required>
                </div>
                <div class="input-group">
                    <label>Confirmar Contrase√±a</label>
                    <input type="password" v-model="registerForm.password_confirm" required>
                </div>
                <button type="submit" class="btn" :disabled="loading">
                    <span v-if="loading">Registrando...</span>
                    <span v-else>Registrarse</span>
                </button>
            </form>
        </div>

        <!-- Main App -->
        <div v-else class="container">
            <!-- Header -->
            <div class="header">
                <h1>üå± AgroPredict</h1>
                <p>Sistema Inteligente de Predicci√≥n de Cultivos con Random Forest</p>
                <div class="user-info" v-if="user">
                    <span>Bienvenido, {{ user.first_name }} {{ user.last_name }}</span><br>
                    <small>{{ user.email }}</small><br>
                    <button class="logout-btn" @click="logout">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Input Panel -->
                <div class="panel">
                    <h2>üìä An√°lisis de Suelo</h2>
                    
                    <!-- Manual Input -->
                    <div v-if="inputMode === 'manual'">
                        <div class="input-group">
                            <label>Nitr√≥geno (N) - mg/kg</label>
                            <input type="number" v-model="soilData.nitrogen" step="0.1" min="0">
                        </div>
                        <div class="input-group">
                            <label>F√≥sforo (P) - mg/kg</label>
                            <input type="number" v-model="soilData.phosphorus" step="0.1" min="0">
                        </div>
                        <div class="input-group">
                            <label>Potasio (K) - mg/kg</label>
                            <input type="number" v-model="soilData.potassium" step="0.1" min="0">
                        </div>
                        <div class="input-group">
                            <label>Temperatura (¬∞C)</label>
                            <input type="number" v-model="soilData.temperature" step="0.1" min="0" max="50">
                        </div>
                        <div class="input-group">
                            <label>Humedad (%)</label>
                            <input type="number" v-model="soilData.humidity" step="0.1" min="0" max="100">
                        </div>
                        <div class="input-group">
                            <label>pH del Suelo</label>
                            <input type="number" v-model="soilData.ph" step="0.1" min="0" max="14">
                        </div>
                        <div class="input-group">
                            <label>Precipitaci√≥n (mm)</label>
                            <input type="number" v-model="soilData.rainfall" step="0.1" min="0">
                        </div>
                        
                        <button class="btn" @click="predictFromManualInput" :disabled="!isManualInputValid || loading">
                            <span v-if="loading">üîÆ Prediciendo...</span>
                            <span v-else>üîÆ Predecir Cultivo √ìptimo</span>
                        </button>
                    </div>

                    <!-- File Upload -->
                    <div v-else>
                        <div class="file-upload" 
                             @click="$refs.fileInput.click()"
                             @dragover.prevent="dragOver = true"
                             @dragleave.prevent="dragOver = false"
                             @drop.prevent="handleFileDrop"
                             :class="{ 'drag-over': dragOver }">
                            <div v-if="!uploadedFile">
                                <p>üìÅ Arrastra tu archivo CSV aqu√≠ o haz clic para seleccionar</p>
                                <small>Formato esperado: N, P, K, temperature, humidity, ph, rainfall</small>
                            </div>
                            <div v-else>
                                <p>‚úÖ {{ uploadedFile.name }}</p>
                                <small>Archivo listo para subir</small>
                            </div>
                        </div>
                        <input type="file" 
                               ref="fileInput" 
                               @change="handleFileUpload" 
                               accept=".csv" 
                               style="display: none;">
                        
                        <button class="btn" 
                                @click="uploadAndPredict" 
                                :disabled="!uploadedFile || loading"
                                style="margin-top: 15px;">
                            <span v-if="loading">üöÄ Procesando...</span>
                            <span v-else>üöÄ Subir y Procesar CSV</span>
                        </button>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        <button @click="toggleInputMode" class="btn btn-secondary">
                            {{ inputMode === 'manual' ? 'üìÅ Cambiar a CSV' : '‚úèÔ∏è Entrada Manual' }}
                        </button>
                    </div>
                </div>

                <!-- Datasets and Visualization Panel -->
                <div class="panel">
                    <h2>üìà Datasets y Visualizaci√≥n</h2>
                    
                    <div v-if="datasets.length > 0">
                        <h3>Mis Datasets</h3>
                        <div class="datasets-list">
                            <div v-for="dataset in datasets" :key="dataset.id" class="dataset-item">
                                <div class="dataset-header">
                                    <span class="dataset-name">{{ dataset.name }}</span>
                                    <span class="dataset-meta">{{ dataset.rows_count }} registros</span>
                                </div>
                                <div class="dataset-meta">
                                    Subido: {{ formatDate(dataset.created_at) }}
                                </div>
                                <div class="dataset-actions">
                                    <button class="btn btn-small" @click="predictDataset(dataset.id)" :disabled="loading">
                                        Predecir
                                    </button>
                                    <button class="btn btn-small btn-danger" @click="deleteDataset(dataset.id)" :disabled="loading">
                                        Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="hasDataToShow" class="chart-container">
                        <canvas ref="soilChart"></canvas>
                    </div>
                    
                    <div v-if="!hasDataToShow && datasets.length === 0">
                        <p style="text-align: center; color: #718096; margin-top: 50px;">
                            üìä Sube un dataset o ingresa datos manualmente para empezar
                        </p>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            <div v-if="alert.show" :class="['alert', `alert-${alert.type}`]">
                {{ alert.message }}
            </div>

            <!-- Results Section -->
            <div v-if="predictions.length > 0" class="results-section">
                <h2>üéØ Resultados de la Predicci√≥n</h2>
                
                <div v-if="predictions.length === 1" class="prediction-card">
                    <h3>{{ predictions[0].crop_name || predictions[0].crop }}</h3>
                    <div class="confidence">Confianza: {{ predictions[0].confidence }}%</div>
                    <div v-if="predictions[0].season" style="margin-top: 10px; opacity: 0.9;">
                        Temporada: {{ predictions[0].season }}
                    </div>
                </div>

                <div v-else class="predictions-grid">
                    <div v-for="(prediction, index) in predictions.slice(0, 6)" :key="index" class="prediction-mini">
                        <h4>{{ prediction.crop_name || prediction.crop }}</h4>
                        <small>{{ prediction.confidence }}%</small>
                    </div>
                </div>

                <div v-if="predictions.length > 6" style="text-align: center; color: #718096; margin-top: 15px;">
                    Y {{ predictions.length - 6 }} predicciones m√°s...
                </div>

                <div class="recommendations" v-if="currentRecommendation">
                    <h3>üìã Recomendaciones</h3>
                    <p><strong>Cultivo recomendado:</strong> {{ currentRecommendation.crop_name }}</p>
                    <p v-if="currentRecommendation.season"><strong>Temporada √≥ptima:</strong> {{ currentRecommendation.season }}</p>
                    <p v-if="currentRecommendation.harvest_time"><strong>Tiempo de cosecha:</strong> {{ currentRecommendation.harvest_time }}</p>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div v-if="loading" class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 15px;">{{ loadingMessage }}</span>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        // Configuraci√≥n de Axios
        const API_BASE_URL = 'http://localhost:8000/api';
        
        // Configurar interceptores de Axios
        axios.defaults.baseURL = API_BASE_URL;
        axios.interceptors.request.use(
            config => {
                const token = localStorage.getItem('access_token');
                if (token) {
                    config.headers.Authorization = `Bearer ${token}`;
                }
                return config;
            },
            error => Promise.reject(error)
        );

        axios.interceptors.response.use(
            response => response,
            async error => {
                if (error.response?.status === 401) {
                    const refreshToken = localStorage.getItem('refresh_token');
                    if (refreshToken) {
                        try {
                            const response = await axios.post('/auth/token/refresh/', {
                                refresh: refreshToken
                            });
                            localStorage.setItem('access_token', response.data.access);
                            error.config.headers.Authorization = `Bearer ${response.data.access}`;
                            return axios.request(error.config);
                        } catch (refreshError) {
                            localStorage.clear();
                            window.location.reload();
                        }
                    } else {
                        localStorage.clear();
                        window.location.reload();
                    }
                }
                return Promise.reject(error);
            }
        );

        createApp({
            setup() {
                // Reactive data
                const isAuthenticated = ref(false);
                const user = ref(null);
                const authMode = ref('login');
                const loading = ref(false);
                const loadingMessage = ref('');
                
                const loginForm = ref({
                    email: '',
                    password: ''
                });
                
                const registerForm = ref({
                    username: '',
                    first_name: '',
                    last_name: '',
                    email: '',
                    password: '',
                    password_confirm: ''
                });

                const inputMode = ref('manual');
                const dragOver = ref(false);
                const uploadedFile = ref(null);
                const datasets = ref([]);
                const predictions = ref([]);
                const soilChart = ref(null);
                const chartInstance = ref(null);
                
                const soilData = ref({
                    nitrogen: 90,
                    phosphorus: 42,
                    potassium: 43,
                    temperature: 20.8,
                    humidity: 82.0,
                    ph: 6.5,
                    rainfall: 202.9
                });

                const alert = ref({
                    show: false,
                    type: 'success',
                    message: ''
                });

                // Computed properties
                const isManualInputValid = computed(() => {
                    return Object.values(soilData.value).every(val => val !== '' && val !== null && val !== undefined);
                });

                const hasDataToShow = computed(() => {
                    return (inputMode.value === 'manual' && isManualInputValid.value) || datasets.value.length > 0;
                });

                const currentRecommendation = computed(() => {
                    return predictions.value.length > 0 ? predictions.value[0] : null;
                });

                // Methods
                const showAlert = (message, type = 'success') => {
                    alert.value = { show: true, message, type };
                    setTimeout(() => {
                        alert.value.show = false;
                    }, 5000);
                };

                const setLoading = (isLoading, message = '') => {
                    loading.value = isLoading;
                    loadingMessage.value = message;
                };

                // Authentication methods
                const login = async () => {
                    setLoading(true, 'Iniciando sesi√≥n...');
                    try {
                        const response = await axios.post('/auth/login/', loginForm.value);
                        
                        localStorage.setItem('access_token', response.data.access);
                        localStorage.setItem('refresh_token', response.data.refresh);
                        
                        user.value = response.data.user;
                        isAuthenticated.value = true;
                        
                        showAlert(response.data.message || 'Inicio de sesi√≥n exitoso');
                        await loadUserData();
                    } catch (error) {
                        showAlert(error.response?.data?.error || 'Error en el inicio de sesi√≥n', 'error');
                    } finally {
                        setLoading(false);
                    }
                };

                const register = async () => {
                    if (registerForm.value.password !== registerForm.value.password_confirm) {
                        showAlert('Las contrase√±as no coinciden', 'error');
                        return;
                    }

                    setLoading(true, 'Registrando usuario...');
                    try {
                        const response = await axios.post('/auth/register/', registerForm.value);
                        
                        localStorage.setItem('access_token', response.data.access);
                        localStorage.setItem('refresh_token', response.data.refresh);
                        
                        user.value = response.data.user;
                        isAuthenticated.value = true;
                        
                        showAlert(response.data.message || 'Registro exitoso');
                        await loadUserData();
                    } catch (error) {
                        const errors = error.response?.data;
                        if (typeof errors === 'object') {
                            const errorMessages = Object.values(errors).flat().join(', ');
                            showAlert(errorMessages, 'error');
                        } else {
                            showAlert('Error en el registro', 'error');
                        }
                    } finally {
                        setLoading(false);
                    }
                };

                const logout = () => {
                    localStorage.clear();
                    user.value = null;
                    isAuthenticated.value = false;
                    datasets.value = [];
                    predictions.value = [];
                    showAlert('Sesi√≥n cerrada exitosamente', 'info');
                };

                const checkAuthStatus = async () => {
                    const token = localStorage.getItem('access_token');
                    if (token) {
                        try {
                            const response = await axios.get('/auth/profile/');
                            user.value = response.data;
                            isAuthenticated.value = true;
                            await loadUserData();
                        } catch (error) {
                            localStorage.clear();
                        }
                    }
                };

                // Data loading methods
                const loadUserData = async () => {
                    await Promise.all([
                        loadDatasets(),
                        loadRecentPredictions()
                    ]);
                };

                const loadDatasets = async () => {
                    try {
                        const response = await axios.get('/datasets/');
                        datasets.value = response.data.results || response.data;
                    } catch (error) {
                        console.error('Error loading datasets:', error);
                    }
                };

                const loadRecentPredictions = async () => {
                    try {
                        const response = await axios.get('/predictions/?limit=10');
                        // No mostrar las predicciones autom√°ticamente, solo cargarlas
                    } catch (error) {
                        console.error('Error loading predictions:', error);
                    }
                };

                // File handling methods
                const toggleInputMode = () => {
                    inputMode.value = inputMode.value === 'manual' ? 'csv' : 'manual';
                    predictions.value = [];
                    uploadedFile.value = null;
                };

                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        processFile(file);
                    }
                };

                const handleFileDrop = (event) => {
                    dragOver.value = false;
                    const file = event.dataTransfer.files[0];
                    if (file) {
                        processFile(file);
                    }
                };

                const processFile = (file) => {
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        showAlert('Por favor selecciona un archivo CSV v√°lido', 'error');
                        return;
                    }

                    if (file.size > 10 * 1024 * 1024) {  // 10MB limit
                        showAlert('El archivo es demasiado grande (m√°ximo 10MB)', 'error');
                        return;
                    }

                    uploadedFile.value = file;
                    showAlert('Archivo CSV seleccionado correctamente', 'success');
                };

                // Prediction methods
                const predictFromManualInput = async () => {
                    if (!isManualInputValid.value) {
                        showAlert('Por favor completa todos los campos', 'error');
                        return;
                    }

                    setLoading(true, 'Realizando predicci√≥n...');
                    try {
                        const response = await axios.post('/predict/manual/', soilData.value);
                        
                        predictions.value = response.data.predictions || [];
                        showAlert(response.data.message || 'Predicci√≥n completada exitosamente');
                        updateChart();
                    } catch (error) {
                        const errorMsg = error.response?.data?.error || 'Error en la predicci√≥n';
                        showAlert(errorMsg, 'error');
                    } finally {
                        setLoading(false);
                    }
                };

                const uploadAndPredict = async () => {
                    if (!uploadedFile.value) {
                        showAlert('No hay archivo seleccionado', 'error');
                        return;
                    }

                    setLoading(true, 'Subiendo y procesando archivo...');
                    
                    const formData = new FormData();
                    formData.append('file', uploadedFile.value);
                    formData.append('name', uploadedFile.value.name);

                    try {
                        // Subir archivo CSV
                        const uploadResponse = await axios.post('/upload/', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            }
                        });

                        showAlert(uploadResponse.data.message);
                        
                        // Recargar datasets
                        await loadDatasets();
                        
                        // Realizar predicciones autom√°ticamente
                        const datasetId = uploadResponse.data.dataset_id;
                        if (datasetId) {
                            setLoading(true, 'Realizando predicciones...');
                            
                            const predictResponse = await axios.post(`/predict/csv/${datasetId}/`);
                            
                            predictions.value = predictResponse.data.predictions || [];
                            showAlert(predictResponse.data.message);
                        }
                        
                        uploadedFile.value = null;
                        if (document.querySelector('input[type="file"]')) {
                            document.querySelector('input[type="file"]').value = '';
                        }
                        
                    } catch (error) {
                        const errorMsg = error.response?.data?.error || 'Error procesando archivo';
                        showAlert(errorMsg, 'error');
                    } finally {
                        setLoading(false);
                    }
                };

                const predictDataset = async (datasetId) => {
                    setLoading(true, 'Realizando predicciones del dataset...');
                    try {
                        const response = await axios.post(`/predict/csv/${datasetId}/`);
                        
                        predictions.value = response.data.predictions || [];
                        showAlert(response.data.message);
                    } catch (error) {
                        const errorMsg = error.response?.data?.error || 'Error en las predicciones';
                        showAlert(errorMsg, 'error');
                    } finally {
                        setLoading(false);
                    }
                };

                const deleteDataset = async (datasetId) => {
                    if (!confirm('¬øEst√°s seguro de que quieres eliminar este dataset?')) {
                        return;
                    }

                    setLoading(true, 'Eliminando dataset...');
                    try {
                        await axios.delete(`/datasets/${datasetId}/`);
                        showAlert('Dataset eliminado exitosamente');
                        await loadDatasets();
                        
                        // Limpiar predicciones si eran de este dataset
                        predictions.value = [];
                    } catch (error) {
                        const errorMsg = error.response?.data?.error || 'Error eliminando dataset';
                        showAlert(errorMsg, 'error');
                    } finally {
                        setLoading(false);
                    }
                };

                // Chart methods
                const updateChart = () => {
                    nextTick(() => {
                        if (!soilChart.value) return;

                        const ctx = soilChart.value.getContext('2d');
                        
                        if (chartInstance.value) {
                            chartInstance.value.destroy();
                        }

                        let data, labels;
                        
                        if (inputMode.value === 'manual' && isManualInputValid.value) {
                            data = [
                                soilData.value.nitrogen,
                                soilData.value.phosphorus,
                                soilData.value.potassium,
                                soilData.value.temperature,
                                soilData.value.humidity,
                                soilData.value.ph * 10, // Scale pH for visibility
                                soilData.value.rainfall / 10 // Scale rainfall for visibility
                            ];
                            labels = ['N (mg/kg)', 'P (mg/kg)', 'K (mg/kg)', 'Temp (¬∞C)', 'Humedad (%)', 'pH (x10)', 'Lluvia (/10)'];
                        } else if (datasets.value.length > 0) {
                            // Show basic info about datasets
                            data = datasets.value.map(d => d.rows_count);
                            labels = datasets.value.map(d => d.name.substring(0, 10) + '...');
                            
                            // If we have manual data, show that instead
                            if (isManualInputValid.value) {
                                data = [
                                    soilData.value.nitrogen,
                                    soilData.value.phosphorus,
                                    soilData.value.potassium,
                                    soilData.value.temperature,
                                    soilData.value.humidity,
                                    soilData.value.ph * 10,
                                    soilData.value.rainfall / 10
                                ];
                                labels = ['N', 'P', 'K', 'Temp', 'Humedad', 'pH (x10)', 'Lluvia (/10)'];
                            }
                        }

                        if (data && labels) {
                            const chartType = inputMode.value === 'manual' || isManualInputValid.value ? 'radar' : 'bar';
                            
                            chartInstance.value = new Chart(ctx, {
                                type: chartType,
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: inputMode.value === 'manual' ? 'Par√°metros del Suelo' : 'Registros por Dataset',
                                        data: data,
                                        borderColor: 'rgb(102, 126, 234)',
                                        backgroundColor: chartType === 'radar' ? 'rgba(102, 126, 234, 0.2)' : 'rgba(102, 126, 234, 0.6)',
                                        borderWidth: 2,
                                        pointBackgroundColor: 'rgb(102, 126, 234)',
                                        pointBorderColor: '#fff',
                                        pointHoverBackgroundColor: '#fff',
                                        pointHoverBorderColor: 'rgb(102, 126, 234)'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    },
                                    scales: chartType === 'radar' ? {
                                        r: {
                                            beginAtZero: true,
                                            grid: {
                                                color: 'rgba(0, 0, 0, 0.1)'
                                            },
                                            angleLines: {
                                                color: 'rgba(0, 0, 0, 0.1)'
                                            }
                                        }
                                    } : {
                                        y: {
                                            beginAtZero: true,
                                            grid: {
                                                color: 'rgba(0, 0, 0, 0.1)'
                                            }
                                        },
                                        x: {
                                            grid: {
                                                color: 'rgba(0, 0, 0, 0.1)'
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                };

                // Utility methods
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                // Lifecycle
                onMounted(async () => {
                    await checkAuthStatus();
                    updateChart();
                });

                return {
                    // Auth state
                    isAuthenticated,
                    user,
                    authMode,
                    loginForm,
                    registerForm,
                    login,
                    register,
                    logout,
                    
                    // App state
                    loading,
                    loadingMessage,
                    inputMode,
                    dragOver,
                    uploadedFile,
                    datasets,
                    predictions,
                    soilData,
                    alert,
                    soilChart,
                    
                    // Computed
                    isManualInputValid,
                    hasDataToShow,
                    currentRecommendation,
                    
                    // Methods
                    toggleInputMode,
                    handleFileUpload,
                    handleFileDrop,
                    predictFromManualInput,
                    uploadAndPredict,
                    predictDataset,
                    deleteDataset,
                    updateChart,
                    formatDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>